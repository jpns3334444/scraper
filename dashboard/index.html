<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東京 Real Estate</title>
    
    <!-- Japanese-inspired Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23F7F5F2'/><circle cx='16' cy='16' r='10' fill='%23695b8d' opacity='0.8'/></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+Antique:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Noto Sans JP', 'Hiragino Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #F7F5F2;
            color: #222222;
            line-height: 1.7;
            font-size: 15px;
            overflow-x: hidden;
            position: relative;
            font-weight: 400;
        }
        
        /* Subtle Mt. Fuji background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            right: 0;
            width: 600px;
            height: 400px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 400"><path d="M300 100 L200 300 L400 300 Z" fill="%23e8e4e0" opacity="0.06"/><path d="M300 100 L250 200 L350 200 Z" fill="%23ffffff" opacity="0.08"/></svg>');
            background-repeat: no-repeat;
            background-position: top right;
            background-size: contain;
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: none;
            width: 100%;
            margin: 0;
            padding: 40px 9px;
            position: relative;
            z-index: 10;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }
        
        h1 {
            color: #222222;
            margin-bottom: 40px;
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            font-family: 'Zen Kaku Gothic Antique', serif;
            letter-spacing: 0.15em;
            position: relative;
            padding-bottom: 20px;
        }
        
        /* Brushstroke underline */
        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, #695b8d 20%, #695b8d 80%, transparent 100%);
            border-radius: 2px;
        }
        
        .results-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 16px 24px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            position: relative;
        }
        
        .results-count {
            font-size: 14px;
            color: #666666;
            font-weight: 400;
            font-family: 'Noto Sans JP', sans-serif;
        }
        
        /* Table Container */
        .table-container {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            overflow: visible;
            position: relative;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-family: 'Noto Sans JP', sans-serif;
            table-layout: fixed;
        }
        
        th {
            background: #f1eee8;
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 700;
            font-size: 13px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #333333;
            border-bottom: 1px solid #cccccc;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        thead th {
            position: sticky;
            top: 0;
            background: #f1eee8;
            z-index: 20;
        }
        
        th.sortable {
            user-select: none;
        }
        
        .column-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 14px 16px;
            cursor: pointer;
            min-height: 45px;
            transition: all 120ms ease;
            position: relative;
        }
        
        .column-header:hover {
            background: rgba(105, 91, 141, 0.05);
        }
        
        .sort-arrows {
            font-size: 11px;
            color: #999999;
            margin-left: 6px;
            transition: all 120ms ease;
        }
        
        .sort-arrows.active {
            color: #695b8d;
            font-weight: 700;
        }
        
        td {
            border-bottom: 1px solid #f0f0f0;
            padding: 14px 16px;
            font-size: 14px;
            vertical-align: middle;
            color: #333333;
            font-family: 'Noto Sans JP', sans-serif;
            font-weight: 400;
            position: relative;
            word-break: break-word;
        }
        
        /* Zebra striping */
        tbody tr:nth-child(odd) td {
            background: #ffffff;
        }
        
        tbody tr:nth-child(even) td {
            background: #fafaf8;
        }
        
        tbody tr {
            transition: all 120ms ease;
            animation: fadeInUp 0.3s ease-out;
        }
        
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* First and last cell rounded corners */
        tbody tr td:first-child {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        
        tbody tr td:last-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        
        /* Hover state */
        tbody tr:hover td {
            background: #f3f0f8 !important;
            transform: translateY(-1px) scale(1.002);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }
        
        /* Clickable row */
        tbody tr {
            cursor: pointer;
        }
        
        tbody tr.no-link {
            cursor: default;
        }
        
        .property-image {
            width: 50px;
            height: 38px;
            object-fit: cover;
            border-radius: 4px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #999999;
            border: 1px solid #e0e0e0;
            font-family: 'Noto Sans JP', sans-serif;
            overflow: hidden;
        }
        
        .skull-icon {
            color: #cccccc;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 16px;
            display: inline-block;
        }
        
        .price {
            font-weight: 500;
            color: #333333;
            text-align: right;
            font-size: 15px;
            font-family: 'Noto Sans JP', sans-serif;
        }
        
        .numeric {
            text-align: center;
            font-weight: 500;
        }
        
        .percent {
            text-align: center;
            font-weight: 500;
            font-family: monospace;
        }
        
        .age {
            text-align: center;
            color: #666666;
        }
        
        .no-data {
            color: #cccccc;
            font-style: italic;
        }
        
        .verdict {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
            letter-spacing: 0.1em;
            transition: all 120ms ease;
            font-family: 'Noto Sans JP', sans-serif;
            position: relative;
            border: 1px solid transparent;
        }
        
        .verdict-buy, .verdict-strong_buy {
            background: #e6f4ea;
            color: #2e7d32;
            border-color: #2e7d32;
        }
        
        .verdict-hold {
            background: #fff4e5;
            color: #b26a00;
            border-color: #b26a00;
        }
        
        .verdict-pass {
            background: #fdecea;
            color: #c62828;
            border-color: #c62828;
        }
        
        .verdict:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .link-button {
            color: #333333;
            text-decoration: none;
            font-weight: 400;
            font-size: 12px;
            font-family: 'Noto Sans JP', sans-serif;
            padding: 6px 12px;
            border: 1px solid #cccccc;
            border-radius: 4px;
            background: transparent;
            transition: all 120ms ease;
            display: inline-block;
        }
        
        .link-button:hover {
            background: #f3f0f8;
            border-color: #695b8d;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        /* Scroll sentinel */
        #scrollSentinel {
            height: 20px;
            margin-top: 20px;
        }
        
        /* Status Bar */
        .terminal-status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #ffffff;
            border-top: 1px solid #e0e0e0;
            padding: 12px 24px;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 12px;
            color: #666666;
            z-index: 999;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.04);
        }
        
        .status-left, .status-right {
            display: flex;
            gap: 24px;
        }
        
        .status-item {
            color: #666666;
        }
        
        /* Loading */
        .loading {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            overflow: hidden;
            position: relative;
            padding: 24px;
        }
        
        .loading::before {
            content: 'Loading properties...';
            position: absolute;
            top: 20px;
            left: 24px;
            color: #999999;
            font-size: 13px;
            font-family: 'Noto Sans JP', sans-serif;
        }
        
        .skeleton {
            animation: skeleton-loading 1.5s infinite ease-in-out;
        }
        
        .skeleton-row {
            display: flex;
            padding: 14px 16px;
            border-bottom: 1px solid #f0f0f0;
            margin-top: 40px;
        }
        
        .skeleton-cell {
            height: 20px;
            background: linear-gradient(90deg, 
                #f5f5f5 0%, 
                #eeeeee 25%, 
                #f5f5f5 50%, 
                #eeeeee 75%,
                #f5f5f5 100%
            );
            background-size: 200% 100%;
            border-radius: 4px;
            margin-right: 12px;
            position: relative;
        }
        
        .skeleton-cell:last-child {
            margin-right: 0;
        }
        
        .skeleton-cell.link { width: 80px; }
        .skeleton-cell.price { width: 120px; }
        .skeleton-cell.ward { width: 100px; }
        .skeleton-cell.percent { width: 80px; }
        .skeleton-cell.station { width: 120px; }
        .skeleton-cell.numeric { width: 80px; }
        .skeleton-cell.age { width: 100px; }
        .skeleton-cell.light { width: 100px; }
        .skeleton-cell.verdict { width: 80px; }
        
        @keyframes skeleton-loading {
            0% { 
                background-position: -200% 0;
            }
            100% { 
                background-position: 200% 0;
            }
        }
        
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            position: relative;
            color: #666666;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 14px;
            transition: all 120ms ease;
        }
        
        .tab-button.active {
            color: #695b8d;
            border-bottom: 3px solid #695b8d;
        }
        
        .tab-button:hover {
            color: #695b8d;
        }
        
        .favorites-count {
            background: #e91e63;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* Heart Button */
        .heart-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: 4px 8px;
            transition: all 0.2s;
            color: #cccccc;
        }
        
        .heart-btn.favorited {
            color: #e91e63;
        }
        
        .heart-btn:hover {
            transform: scale(1.1);
        }
        
        .heart-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Favorites Grid */
        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }
        
        .favorite-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            background: #ffffff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }
        
        .favorite-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .favorite-image {
            height: 200px;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .favorite-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .no-image {
            color: #999999;
            font-size: 14px;
        }
        
        .favorite-details {
            padding: 15px;
        }
        
        .favorite-price {
            font-size: 18px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 8px;
        }
        
        .favorite-location {
            color: #666666;
            margin-bottom: 4px;
        }
        
        .favorite-size {
            color: #666666;
            margin-bottom: 10px;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            font-weight: 500;
        }
        
        .status-completed {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-processing {
            background: #fef5e7;
            color: #744210;
        }
        
        .status-failed {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status-pending {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        /* Style for the new favorites list */
        .fav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .fav-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding: 14px 8px;
            font-size: 14px;
        }
        
        .fav-status {
            font-size: 12px;
            font-style: italic;
            color: #666;
        }
        
        .fav-status.completed {
            color: #22543d;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .fav-status.completed:hover {
            color: #276749;
        }

        
        /* Column Filter Dropdown */
        .filter-dropdown {
            position: relative;
            display: inline-block;
            margin-left: 8px;
        }
        
        .filter-btn {
            background: none;
            border: none;
            font-size: 12px;
            color: #999999;
            cursor: pointer;
            padding: 2px 6px;
            transition: all 120ms ease;
        }
        
        .filter-btn:hover {
            color: #695b8d;
            background: rgba(105, 91, 141, 0.1);
            border-radius: 4px;
        }
        
        .filter-btn.active {
            color: #695b8d;
            font-weight: 700;
        }
        
        .filter-dropdown-content {
            display: none;
            position: absolute;
            background: #ffffff;
            min-width: 160px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 30;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .filter-dropdown-content.show {
            display: block;
        }
        
        .filter-dropdown-content label {
            display: block;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            transition: all 120ms ease;
        }
        
        .filter-dropdown-content label:hover {
            background: #f3f0f8;
        }
        
        .filter-dropdown-content input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .filter-dropdown-content .filter-actions {
            padding: 8px 12px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
        }
        
        .filter-dropdown-content button {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #cccccc;
            background: #ffffff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 120ms ease;
        }
        
        .filter-dropdown-content button:hover {
            background: #f3f0f8;
        }
        
        /* Pagination at bottom */
        .pagination-container {
            margin-top: 20px;
            padding: 20px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .pagination button {
            padding: 6px 12px;
            border: 1px solid #cccccc;
            background: #ffffff;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 120ms ease;
            font-family: 'Noto Sans JP', sans-serif;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #f3f0f8;
            border-color: #695b8d;
        }
        
        .pagination button.active {
            background: #695b8d;
            color: #ffffff;
            border-color: #695b8d;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .page-info {
            font-size: 13px;
            color: #666666;
            margin: 0 8px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            body::before {
                width: 300px;
                height: 200px;
            }
            
            .container {
                padding: 20px 4.5px;
                margin: 0;
                border-radius: 8px;
            }
            
            h1 {
                font-size: 32px;
                margin-bottom: 24px;
            }
            
            .results-info {
                flex-direction: column;
                gap: 10px;
                padding: 12px 16px;
            }
            
            td {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .price {
                font-size: 14px;
            }
            
            .link-button {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .terminal-status-bar {
                font-size: 11px;
                padding: 8px 12px;
            }
            
            .status-left, .status-right {
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    
    <div class="container">
        <h1>東京 Real Estate</h1>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('properties')">
                All Properties
            </button>
            <button class="tab-button" onclick="switchTab('favorites')">
                Favorites <span class="favorites-count" id="favoritesCount">0</span>
            </button>
        </div>

        <!-- Properties Tab -->
        <div id="properties-tab" class="tab-pane active">
            <div class="results-info">
                <div class="results-count" id="resultsCount">Loading properties...</div>
            </div>
        </div>

        <!-- Favorites Tab -->
        <div id="favorites-tab" class="tab-pane" style="display: none;">
            <ul class="fav-list" id="favoritesList"></ul>
        </div>
        
        <div class="loading" id="loading">
            <div class="skeleton-row">
                <div class="skeleton-cell numeric skeleton" style="width: 40px;"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell ward skeleton"></div>
                <div class="skeleton-cell percent skeleton"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell station skeleton"></div>
                <div class="skeleton-cell numeric skeleton"></div>
                <div class="skeleton-cell numeric skeleton"></div>
                <div class="skeleton-cell age skeleton"></div>
                <div class="skeleton-cell numeric skeleton"></div>
                <div class="skeleton-cell light skeleton"></div>
                <div class="skeleton-cell verdict skeleton"></div>
            </div>
            <div class="skeleton-row">
                <div class="skeleton-cell numeric skeleton" style="width: 40px;"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell ward skeleton"></div>
                <div class="skeleton-cell percent skeleton"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell station skeleton"></div>
                <div class="skeleton-cell numeric skeleton"></div>
                <div class="skeleton-cell numeric skeleton"></div>
                <div class="skeleton-cell age skeleton"></div>
                <div class="skeleton-cell numeric skeleton"></div>
                <div class="skeleton-cell light skeleton"></div>
                <div class="skeleton-cell verdict skeleton"></div>
            </div>
            <div class="skeleton-row">
                <div class="skeleton-cell numeric skeleton" style="width: 40px;"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell ward skeleton"></div>
                <div class="skeleton-cell percent skeleton"></div>
                <div class="skeleton-cell price skeleton"></div>
                <div class="skeleton-cell station skeleton"></div>
                <div class="skeleton-cell numeric skeleton"></div>
                <div class="skeleton-cell numeric skeleton"></div>
                <div class="skeleton-cell age skeleton"></div>
                <div class="skeleton-cell numeric skeleton"></div>
                <div class="skeleton-cell light skeleton"></div>
                <div class="skeleton-cell verdict skeleton"></div>
            </div>
        </div>
        
        <div class="table-container" id="tableContainer" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>♥</th>
                        <th class="sortable" onclick="sortTable('price')">
                            <div class="column-header">
                                Price
                                <span class="sort-arrows" id="sort-price">▲▼</span>
                            </div>
                        </th>
                        <th class="sortable" onclick="sortTable('price_per_sqm')">
                            <div class="column-header">
                                Price/m²
                                <span class="sort-arrows" id="sort-price_per_sqm">▲▼</span>
                            </div>
                        </th>
                        <th class="sortable" onclick="sortTable('total_monthly_costs')">
                            <div class="column-header">
                                Monthly Cost
                                <span class="sort-arrows" id="sort-total_monthly_costs">▲▼</span>
                            </div>
                        </th>
                        <th class="sortable" onclick="sortTable('ward')">
                            <div class="column-header">
                                Ward
                                <span class="sort-arrows" id="sort-ward">▲▼</span>
                                <div class="filter-dropdown">
                                    <button class="filter-btn" onclick="toggleFilterDropdown(event, 'ward')" id="filter-btn-ward">▼</button>
                                    <div class="filter-dropdown-content" id="filter-dropdown-ward">
                                        <div id="ward-filter-options"></div>
                                        <div class="filter-actions">
                                            <button onclick="applyColumnFilter('ward')">Apply</button>
                                            <button onclick="clearColumnFilter('ward')">Clear</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </th>
                        <th class="sortable" onclick="sortTable('ward_discount_pct')">
                            <div class="column-header">
                                Ward Discount %
                                <span class="sort-arrows" id="sort-ward_discount_pct">▲▼</span>
                            </div>
                        </th>
                        <th class="sortable" onclick="sortTable('ward_median_price_per_sqm')">
                            <div class="column-header">
                                Ward Median ¥/m²
                                <span class="sort-arrows" id="sort-ward_median_price_per_sqm">▲▼</span>
                            </div>
                        </th>
                        <th>Closest Station</th>
                        <th class="sortable" onclick="sortTable('station_distance_minutes')">
                            <div class="column-header">
                                Walk Time (min)
                                <span class="sort-arrows" id="sort-station_distance_minutes">▲▼</span>
                            </div>
                        </th>
                        <th class="sortable" onclick="sortTable('floor')">
                            <div class="column-header">
                                Floor
                                <span class="sort-arrows" id="sort-floor">▲▼</span>
                            </div>
                        </th>
                        <th class="sortable" onclick="sortTable('building_age_years')">
                            <div class="column-header">
                                Building Age
                                <span class="sort-arrows" id="sort-building_age_years">▲▼</span>
                            </div>
                        </th>
                        <th class="sortable" onclick="sortTable('size_sqm')">
                            <div class="column-header">
                                Size (m²)
                                <span class="sort-arrows" id="sort-size_sqm">▲▼</span>
                            </div>
                        </th>
                        <th>
                            <div class="column-header">
                                Primary Light
                                <div class="filter-dropdown">
                                    <button class="filter-btn" onclick="toggleFilterDropdown(event, 'primary_light')" id="filter-btn-primary_light">▼</button>
                                    <div class="filter-dropdown-content" id="filter-dropdown-primary_light">
                                        <div id="primary_light-filter-options"></div>
                                        <div class="filter-actions">
                                            <button onclick="applyColumnFilter('primary_light')">Apply</button>
                                            <button onclick="clearColumnFilter('primary_light')">Clear</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </th>
                        <th>
                            <div class="column-header">
                                Verdict
                                <div class="filter-dropdown">
                                    <button class="filter-btn" onclick="toggleFilterDropdown(event, 'verdict')" id="filter-btn-verdict">▼</button>
                                    <div class="filter-dropdown-content" id="filter-dropdown-verdict">
                                        <div id="verdict-filter-options"></div>
                                        <div class="filter-actions">
                                            <button onclick="applyColumnFilter('verdict')">Apply</button>
                                            <button onclick="clearColumnFilter('verdict')">Clear</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody id="propertiesTable">
                </tbody>
            </table>
        </div>
        
        <!-- Pagination at bottom -->
        <div class="pagination-container" id="paginationContainer" style="display: none;">
            <div class="pagination" id="pagination"></div>
        </div>
    </div>
    
    <script>
        // Configuration
        const API_URL = 'https://nbgnatp0pd.execute-api.ap-northeast-1.amazonaws.com/prod';
        const limit = 500;
        
        // State
        let cursor = null;          // null = first page; false = no more pages
        let loading = false;
        let allProperties = [];
        let filteredProperties = [];
        let currentSort = { field: 'price', direction: 'desc' };
        let currentPage = 1;
        let itemsPerPage = 100;
        let favorites = new Set();
        let currentFilters = {
            ward: [],
            primary_light: [],
            verdict: []
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFavoritesFromStorage();
            loadAllProperties();
            updateSortArrows();
            updateFavoritesCount();
        });
        
        // Load favorites from localStorage
        function loadFavoritesFromStorage() {
            const storedFavorites = localStorage.getItem('favorites');
            if (storedFavorites) {
                try {
                    favorites = new Set(JSON.parse(storedFavorites));
                } catch (e) {
                    favorites = new Set();
                }
            }
        }
        
        // Save favorites to localStorage
        function saveFavoritesToStorage() {
            localStorage.setItem('favorites', JSON.stringify([...favorites]));
        }
        
        // Sync favorites with backend
        async function syncFavorites() {
            try {
                const response = await fetch(`${API_URL}/favorites/${getUserId()}`, {
                    headers: { 'X-User-Id': getUserId() }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.favorites && data.favorites.length > 0) {
                        // Get property IDs from backend favorites
                        const backendFavorites = new Set(data.favorites.map(f => f.property_id));
                        
                        // Merge with localStorage favorites
                        favorites = new Set([...favorites, ...backendFavorites]);
                        saveFavoritesToStorage();
                    }
                }
            } catch (error) {
                console.error('Failed to sync favorites:', error);
            }
        }
        
        async function loadAllProperties() {
            loading = true;
            let tempCursor = null;
            let tempProperties = [];
            
            try {
                // Load all properties
                while (tempCursor !== false) {
                    const url = API_URL + '/properties?limit=' + limit +
                               (tempCursor ? '&cursor=' + encodeURIComponent(JSON.stringify(tempCursor)) : '');
                    const res = await fetch(url, {
                        headers: {
                            'X-User-Id': getUserId()
                        }
                    });
                    if (!res.ok) break;
                    
                    const { items, cursor: next } = await res.json();
                    tempProperties = tempProperties.concat(items || []);
                    tempCursor = next ?? false;
                }
                
                // Sync favorites with backend
                await syncFavorites();
                
                // Update favorite status based on synced favorites
                tempProperties.forEach(property => {
                    property.is_favorited = favorites.has(property.property_id);
                });
                
                allProperties = tempProperties;
                filteredProperties = [...allProperties];
                
                // Hide loading and show table
                document.getElementById('loading').style.display = 'none';
                document.getElementById('tableContainer').style.display = 'block';
                
                // Apply initial sort and render
                applySort();
                renderCurrentPage();
                populateColumnFilters();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('resultsCount').textContent = 'Connection error';
            } finally {
                loading = false;
            }
        }
        
        // Render current page
        function renderCurrentPage() {
            const tbody = document.getElementById('propertiesTable');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = filteredProperties.slice(start, end);
            
            tbody.innerHTML = pageItems.map(renderRow).join('');
            
            updateResultsInfo();
            renderPagination();
            
            // Show/hide pagination container
            const paginationContainer = document.getElementById('paginationContainer');
            if (filteredProperties.length > 0) {
                paginationContainer.style.display = 'block';
            } else {
                paginationContainer.style.display = 'none';
            }
        }
        
        // Update results info
        function updateResultsInfo() {
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(currentPage * itemsPerPage, filteredProperties.length);
            const filterText = hasActiveFilters() ? ' (filtered)' : '';
            
            document.getElementById('resultsCount').textContent = 
                `Showing ${start}-${end} of ${filteredProperties.length} properties${filterText}`;
        }
        
        // Check if filters are active
        function hasActiveFilters() {
            return currentFilters.ward.length > 0 || 
                   currentFilters.primary_light.length > 0 || 
                   currentFilters.verdict.length > 0;
        }
        
        function renderRow(property) {
            const price = formatPrice(property.price, '', true);
            const pricePerSqm = formatPrice(property.price_per_sqm);
            const monthyCost = formatPrice(property.total_monthly_costs);
            const ward = property.ward || '<span class="no-data">—</span>';
            const wardDiscount = formatPercent(property.ward_discount_pct);
            const wardMedian = formatPrice(property.ward_median_price_per_sqm);
            const closestStation = property.closest_station || '<span class="no-data">—</span>';
            const walkTime = property.station_distance_minutes 
                ? `${property.station_distance_minutes}`
                : '<span class="no-data">—</span>';
            const floor = property.floor || '<span class="no-data">—</span>';
            const buildingAge = property.building_age_years !== undefined 
                ? `${property.building_age_years} years`
                : '<span class="no-data">—</span>';
            const size = property.size_sqm || property.total_sqm 
                ? `${Math.round(property.size_sqm || property.total_sqm)}`
                : '<span class="no-data">—</span>';
            const primaryLight = property.primary_light || '<span class="no-data">—</span>';
            const verdict = property.verdict || property.recommendation || 'pass';
            const hasLink = property.listing_url && property.listing_url.trim();
            const isFavorited = favorites.has(property.property_id);
            
            return `
                <tr ${hasLink ? `onclick="openListing(event, '${property.listing_url}')"` : 'class="no-link"'}>
                    <td style="text-align: center;">
                        <button class="heart-btn ${isFavorited ? 'favorited' : ''}" 
                                onclick="toggleFavorite('${property.property_id}', this)"
                                data-property-id="${property.property_id}">
                            ${isFavorited ? '♥' : '♡'}
                        </button>
                    </td>
                    <td class="price">${price}</td>
                    <td class="price">${pricePerSqm}</td>
                    <td class="price">${monthyCost}</td>
                    <td>${ward}</td>
                    <td class="percent">${wardDiscount}</td>
                    <td class="price">${wardMedian}</td>
                    <td>${closestStation}</td>
                    <td class="numeric">${walkTime}</td>
                    <td class="numeric">${floor}</td>
                    <td class="age">${buildingAge}</td>
                    <td class="numeric">${size}</td>
                    <td>${primaryLight}</td>
                    <td>
                        <span class="verdict verdict-${verdict}">${verdict.toUpperCase()}</span>
                    </td>
                </tr>
            `;
        }
        
        // Sorting
        function sortTable(field) {
            // Toggle direction if same field, otherwise start with desc
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'desc';
            }
            
            applySort();
            currentPage = 1;
            renderCurrentPage();
        }
        
        // Apply sort to filtered properties
        function applySort() {
            filteredProperties.sort((a, b) => {
                let valA = a[currentSort.field];
                let valB = b[currentSort.field];
                
                // Handle null/undefined values
                if (valA == null && valB == null) return 0;
                if (valA == null) return 1;
                if (valB == null) return -1;
                
                // Convert to numbers for numeric fields
                if (typeof valA === 'string' && !isNaN(valA)) valA = parseFloat(valA);
                if (typeof valB === 'string' && !isNaN(valB)) valB = parseFloat(valB);
                
                let result = 0;
                if (valA < valB) result = -1;
                else if (valA > valB) result = 1;
                
                return currentSort.direction === 'asc' ? result : -result;
            });
            
            updateSortArrows();
        }
        
        function updateSortArrows() {
            // Reset all arrows
            document.querySelectorAll('.sort-arrows').forEach(arrow => {
                arrow.classList.remove('active');
                arrow.textContent = '▲▼';
            });
            
            // Set active arrow
            const activeArrow = document.getElementById(`sort-${currentSort.field}`);
            if (activeArrow) {
                activeArrow.classList.add('active');
                activeArrow.textContent = currentSort.direction === 'asc' ? '▲' : '▼';
            }
        }
        
        // Utility functions
        function formatPrice(price, suffix = '', multiplyBy10k = false) {
            if (!price && price !== 0) return '<span class="no-data">—</span>';
            // Only multiply by 10,000 for main price column (prices stored in 万円)
            const actualPrice = multiplyBy10k ? price * 10000 : price;
            return '¥' + Math.round(actualPrice).toLocaleString() + suffix;
        }
        
        function formatPercent(percent) {
            if (percent === undefined || percent === null) return '<span class="no-data">—</span>';
            const formatted = percent.toFixed(1);
            return formatted > 0 ? `+${formatted}%` : `${formatted}%`;
        }

        // User ID management
        function getUserId() {
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('user_id', userId);
            }
            return userId;
        }

        // Tab functionality
        function switchTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'favorites') {
                document.getElementById('tableContainer').style.display = 'none';
                document.getElementById('loading').style.display = 'none';
                document.getElementById('paginationContainer').style.display = 'none';
                loadFavorites();
            } else {
                document.getElementById('tableContainer').style.display = 'block';
                document.getElementById('paginationContainer').style.display = 'block';
            }
        }
        
        // Helper for instant favorites counter update
        function deltaFavorites(delta) {
            const el = document.getElementById('favoritesCount');
            el.textContent = Math.max(0, (parseInt(el.textContent) || 0) + delta);
        }

        // Open listing in new tab
        function openListing(event, url) {
            // Don't open if clicking on buttons or other interactive elements
            if (event.target.tagName === 'BUTTON' || event.target.closest('button')) {
                return;
            }
            window.open(url, '_blank');
        }
        
        // Toggle favorite
        async function toggleFavorite(propertyId, button) {
            event.stopPropagation(); // Prevent row click
            button.disabled = true;
            const isFavorited = button.classList.contains('favorited');
            
            try {
                if (isFavorited) {
                    await fetch(`${API_URL}/favorites/${getUserId()}_${propertyId}`, {
                        method: 'DELETE',
                        headers: { 'X-User-Id': getUserId() }
                    });
                    button.classList.remove('favorited');
                    button.textContent = '♡';
                    favorites.delete(propertyId);
                    saveFavoritesToStorage();
                    deltaFavorites(-1);
                    
                    // Update property in allProperties array
                    const property = allProperties.find(p => p.property_id === propertyId);
                    if (property) property.is_favorited = false;
                    
                    // If on favorites tab, reload the list
                    if (document.getElementById('favorites-tab').classList.contains('active')) {
                        loadFavorites();
                    }
                } else {
                    await fetch(`${API_URL}/favorites`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-User-Id': getUserId()
                        },
                        body: JSON.stringify({ property_id: propertyId })
                    });
                    button.classList.add('favorited');
                    button.textContent = '♥';
                    favorites.add(propertyId);
                    saveFavoritesToStorage();
                    deltaFavorites(+1);
                    
                    // Update property in allProperties array
                    const property = allProperties.find(p => p.property_id === propertyId);
                    if (property) property.is_favorited = true;
                }
                // Update count is handled by deltaFavorites
            } catch (error) {
                console.error('Failed to toggle favorite:', error);
            } finally {
                button.disabled = false;
            }
        }

        // Load favorites view
        function loadFavorites() {
            const list = document.getElementById('favoritesList');
            
            // Get favorited properties from the full list
            const favoritedProperties = allProperties.filter(p => favorites.has(p.property_id));
            
            if (favoritedProperties.length === 0) {
                list.innerHTML = '<li style="padding:20px; color:#999;">No favorites yet.</li>';
                return;
            }
            
            // Sort favorited properties by price descending
            favoritedProperties.sort((a, b) => (b.price || 0) - (a.price || 0));
            
            list.innerHTML = favoritedProperties.map(property => {
                const price = property.price ? `¥${(property.price * 10000).toLocaleString()}` : '—';
                const size = property.size_sqm || property.total_sqm ? 
                    `${Math.round(property.size_sqm || property.total_sqm)}m²` : '—';
                const ward = property.ward || '—';
                const wardDiscount = property.ward_discount_pct;
                const wardDiscountText = wardDiscount !== undefined && wardDiscount !== null ? 
                    (wardDiscount > 0 ? `+${wardDiscount.toFixed(1)}%` : `${wardDiscount.toFixed(1)}%`) : '';
                const station = property.closest_station || 'No station';
                const verdict = property.verdict || property.recommendation || 'pass';
                const url = property.listing_url || '#';
                
                return `
                    <li class="fav-item">
                        <span>
                            <a href="${url}" target="_blank" style="color: #333; text-decoration: none;">
                                ${price}
                            </a>
                            — ${size}
                            — ${ward}${wardDiscountText ? ` (${wardDiscountText})` : ''}
                            — ${station}
                        </span>
                        <span class="verdict verdict-${verdict}" style="font-size: 11px;">
                            ${verdict.toUpperCase()}
                        </span>
                    </li>`;
            }).join('');
        }

        // Update favorites count from localStorage
        function updateFavoritesCount() {
            document.getElementById('favoritesCount').textContent = favorites.size;
        }

        // View property details (placeholder)
        function viewProperty(propertyId) {
            // Find the property in allProperties
            const property = allProperties.find(p => p.property_id === propertyId);
            if (property && property.listing_url) {
                window.open(property.listing_url, '_blank');
            } else {
                alert('Property details not available');
            }
        }
        
        // View analysis (placeholder for future implementation)
        function viewAnalysis(propertyId) {
            // This would navigate to the analysis page once implemented
            alert('Analysis view coming soon!');
        }
        
        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredProperties.length / itemsPerPage);
            const paginationDiv = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>`;
            
            // Page numbers
            const maxVisiblePages = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                html += `<button onclick="goToPage(1)">1</button>`;
                if (startPage > 2) html += '<span class="page-info">...</span>';
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="goToPage(${i})" class="${i === currentPage ? 'active' : ''}">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) html += '<span class="page-info">...</span>';
                html += `<button onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }
            
            // Next button
            html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>`;
            
            paginationDiv.innerHTML = html;
        }
        
        // Go to page
        function goToPage(page) {
            const totalPages = Math.ceil(filteredProperties.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderCurrentPage();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Toggle filter dropdown
        function toggleFilterDropdown(event, column) {
            event.stopPropagation();
            const dropdown = document.getElementById(`filter-dropdown-${column}`);
            const btn = document.getElementById(`filter-btn-${column}`);
            
            // Close all other dropdowns
            document.querySelectorAll('.filter-dropdown-content').forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });
            
            dropdown.classList.toggle('show');
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.matches('.filter-btn') && !event.target.closest('.filter-dropdown-content')) {
                document.querySelectorAll('.filter-dropdown-content').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });
        
        // Apply column filter
        function applyColumnFilter(column) {
            const checkboxes = document.querySelectorAll(`#${column}-filter-options input[type="checkbox"]:checked`);
            currentFilters[column] = Array.from(checkboxes).map(cb => cb.value);
            
            applyAllFilters();
            
            // Update filter button appearance
            const btn = document.getElementById(`filter-btn-${column}`);
            if (currentFilters[column].length > 0) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            
            // Close dropdown
            document.getElementById(`filter-dropdown-${column}`).classList.remove('show');
        }
        
        // Clear column filter
        function clearColumnFilter(column) {
            currentFilters[column] = [];
            const checkboxes = document.querySelectorAll(`#${column}-filter-options input[type="checkbox"]`);
            checkboxes.forEach(cb => cb.checked = false);
            
            applyAllFilters();
            
            // Update filter button appearance
            document.getElementById(`filter-btn-${column}`).classList.remove('active');
            
            // Close dropdown
            document.getElementById(`filter-dropdown-${column}`).classList.remove('show');
        }
        
        // Apply all filters
        function applyAllFilters() {
            filteredProperties = allProperties.filter(property => {
                // Ward filter
                if (currentFilters.ward.length > 0 && !currentFilters.ward.includes(property.ward)) {
                    return false;
                }
                
                // Primary light filter
                if (currentFilters.primary_light.length > 0 && !currentFilters.primary_light.includes(property.primary_light)) {
                    return false;
                }
                
                // Verdict filter
                if (currentFilters.verdict.length > 0) {
                    const propertyVerdict = property.verdict || property.recommendation || 'pass';
                    if (!currentFilters.verdict.includes(propertyVerdict.toLowerCase())) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Reset to first page and re-sort
            currentPage = 1;
            applySort();
            renderCurrentPage();
        }
        
        // Populate column filters
        function populateColumnFilters() {
            // Ward filter
            const wards = [...new Set(allProperties.map(p => p.ward).filter(Boolean))].sort();
            const wardOptions = document.getElementById('ward-filter-options');
            wardOptions.innerHTML = wards.map(ward => `
                <label>
                    <input type="checkbox" value="${ward}"> ${ward}
                </label>
            `).join('');
            
            // Primary light filter
            const lights = [...new Set(allProperties.map(p => p.primary_light).filter(Boolean))].sort();
            const lightOptions = document.getElementById('primary_light-filter-options');
            lightOptions.innerHTML = lights.map(light => `
                <label>
                    <input type="checkbox" value="${light}"> ${light}
                </label>
            `).join('');
            
            // Verdict filter
            const verdicts = [...new Set(allProperties.map(p => (p.verdict || p.recommendation || 'pass').toLowerCase()))].sort();
            const verdictOptions = document.getElementById('verdict-filter-options');
            verdictOptions.innerHTML = verdicts.map(verdict => `
                <label>
                    <input type="checkbox" value="${verdict}"> ${verdict.toUpperCase()}
                </label>
            `).join('');
        }
        
    </script>
</body>
</html>