
# Migration Gaps Analysis

This document outlines the gaps between the current codebase and the LEAN_MIGRATIONPROMPT_V1.3.md specification.

## 1. `ai-infra/lambda/etl/app.py`

*   **Status:** Mostly implemented.
*   **Gaps:**
    *   The logic for handling `is_candidate == True` is present, but it's not explicitly filtering for it before passing data to the next step. This is a minor issue, as the `llm_batch` lambda is expected to handle this, but it's worth noting.

## 2. `ai-infra/lambda/llm_batch/app.py`

*   **Status:** Partially implemented.
*   **Gaps:**
    *   **Schema Mismatch:** The file uses the old `evaluation_min.json` schema and `validate_llm_output` function. This is a major gap that needs to be addressed.
    *   **Fallback Mismatch:** The `create_fallback_evaluation` function generates a response that doesn't match the target schema.
    *   **Score Overwriting:** The logic to force `base_score` in the output to match the deterministic `base_score` is missing.
    *   **Final Score Check:** The check to ensure `final_score` is not nonsensically lower than `base_score` is missing.

## 3. `ai-infra/lambda/prompt_builder/app.py`

*   **Status:** Partially implemented.
*   **Gaps:**
    *   **System Prompt:** The `load_lean_system_prompt` function and its fallback `get_lean_fallback_prompt` do not match the system prompt structure specified in the migration document.
    *   **Image Limiting:** The `limit_images_to_three` function correctly limits the number of images, but the migration prompt also specifies that only the *first 3* images should be used. The current implementation does not enforce this.
    *   **Token Controls:** The token control logic is present, but it relies on a rough estimation of token count. The migration prompt is more specific about how to handle token limits.
    *   **Comparables Formatting:** The `format_comparables_lean` function is close, but the migration prompt specifies a slightly different format for the comparable lines.

## 4. `notifications/daily_digest.py` and `notifications/notifier.py`

*   **Status:** Partially implemented.
*   **Gaps:**
    *   **Filtering:** The digest should only include `BUY_CANDIDATE` verdicts, limited to 10. The current implementation doesn't filter by verdict and takes the top 10 candidates by score.
    *   **HTML Content:** The HTML content is more elaborate than the minimal digest specified in the migration plan.
    *   **CSV Generation:** The CSV generation is present, but the migration plan makes it optional.
    *   **Metrics:** The metrics emitted are not the ones specified in the migration plan.

## 5. `schemas/evaluation_min.json`

*   **Status:** Incorrect.
*   **Gaps:**
    *   The schema in this file does not match the schema defined in the migration prompt. This is a major gap that needs to be addressed.

## 6. `schemas/validate.py`

*   **Status:** Incorrect.
*   **Gaps:**
    *   This file uses the incorrect `evaluation_min.json` schema and includes business logic validation that is inconsistent with the migration prompt's schema.

## 7. `snapshots/snapshot_manager.py`

*   **Status:** Partially implemented.
*   **Gaps:**
    *   **Global Snapshot Content:** The global snapshot generated by this script includes more information than specified in the migration plan.
    *   **Ward Snapshot Content:** The ward snapshot contains more data than specified in the plan.
    *   **p25/p75 Omission:** The logic to omit the `p25` and `p75` keys if there are fewer than 4 listings is missing.

## 8. `tests`

*   **Status:** Partially implemented.
*   **Gaps:**
    *   `test_prompt_lean.py`: This file is testing the old prompt building logic.
    *   `test_eval_schema.py`: This file is testing the old `evaluation_min.json` schema.
    *   `test_digest.py`: This file needs to be updated to reflect the new requirements for the daily digest.
